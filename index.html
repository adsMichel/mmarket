<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scanner de Produtos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
      body {
        /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
        background-image: url("mary2.jpeg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      #interactive {
        width: 100%;
        height: 100%;
      }

      #interactive video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .scanner-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 280px;
        height: 280px;
        border: 3px solid #fcd34d;
        border-radius: 24px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        pointer-events: none;
      }

      .scanner-line {
        position: absolute;
        width: 100%;
        height: 3px;
        background: #fcd34d;
        top: 50%;
      }

      @keyframes scan {
        0%,
        100% {
          top: 10%;
        }
        50% {
          top: 90%;
        }
      }

      .corner {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 4px solid #fcd34d;
      }

      .corner-tl {
        top: -2px;
        left: -2px;
        border-right: none;
        border-bottom: none;
        border-radius: 24px 0 0 0;
      }
      .corner-tr {
        top: -2px;
        right: -2px;
        border-left: none;
        border-bottom: none;
        border-radius: 0 24px 0 0;
      }
      .corner-bl {
        bottom: -2px;
        left: -2px;
        border-right: none;
        border-top: none;
        border-radius: 0 0 0 24px;
      }
      .corner-br {
        bottom: -2px;
        right: -2px;
        border-left: none;
        border-top: none;
        border-radius: 0 0 24px 0;
      }
    </style>
  </head>
  <body class="h-screen overflow-hidden">
    <!-- Tela Inicial (Home) -->
    <div
      id="home-screen"
      class="h-full flex flex-col items-center justify-center p-6"
    >
      <!-- <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
            <div class="mb-6">
                <svg class="w-24 h-24 mx-auto text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Scanner de Produtos</h1>
            <p class="text-gray-600 mb-8">Escaneie códigos de barras para adicionar produtos</p>
            <div id="nome-produto" class="text-lg text-gray-700 font-medium mb-4">Aguardando código...</div>
        </div> -->
        <div id="nome-produto" class="text-lg text-gray-100 font-medium mb-4"></div>
    </div>

    <!-- Área do Scanner -->
    <div id="scanner-area" class="hidden fixed inset-0 w-full h-full">
      <!-- Cabeçalho -->
      <div
        class="absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/60 to-transparent p-4"
      >
      </div>

      <!-- Área da câmera -->
      <div id="interactive" class="w-full h-full bg-gray-900"></div>

      <!-- Overlay do Scanner -->
      <div class="scanner-overlay">
        <div class="corner corner-tl"></div>
        <div class="corner corner-tr"></div>
        <div class="corner corner-bl"></div>
        <div class="corner corner-br"></div>
        <div class="scanner-line"></div>
      </div>

    </div>

    <!-- Botões Inferiores (sempre visíveis) -->
    <div
      class="fixed bottom-0 left-0 right-0 z-30 bg-gradient-to-t from-black/80 to-transparent pb-8 pt-6"
    >
      <div class="flex justify-around items-end px-8 max-w-md mx-auto">
        <!-- Botão Início (antes era Histórico) -->
        <button
          id="btn-home"
          class="flex flex-col items-center gap-2 text-white/70 hover:text-white transition"
        >
          <div
            class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              />
            </svg>
          </div>
          <span class="text-xs font-medium">Início</span>
        </button>
        <!-- Botão Ler (Principal) -->
        <button id="btn-ler" class="flex flex-col items-center gap-2 -mt-4">
          <div
            class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-2xl flex items-center justify-center shadow-lg shadow-yellow-500/50 hover:scale-105 transition transform"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
              />
            </svg>
          </div>
          <span class="text-white text-xs font-medium">Ler</span>
        </button>

        <!-- Botão inicio -->
        <button
          class="flex flex-col items-center gap-2 text-white/70 hover:text-white transition"
        >
          <div
            class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm"
          >
            <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="w-6 h-6"
          >
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />

            <circle cx="12" cy="7" r="4" />
          </svg>
          </div>
          <span class="text-xs font-medium">Perfil</span>
        </button>
      </div>
    </div>

<div id="product-modal" class=" fixed inset-0 bg-black/50 backdrop-blur-sm z-40 flex p-4 items-start justify-center">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 mt-4">
            <div class="flex justify-end mb-6">
                <button class="close-button text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="bg-purple-50 rounded-xl p-4 mb-4">
                    <p id="modal-product-name" class="text-purple-900 font-medium text-center">Nome do Produto</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
                        <input 
                            type="number" 
                            id="input-quantidade" 
                            value="0" 
                            min="0"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (R$)</label>
                        <input 
                            type="number" 
                            id="input-valor" 
                            placeholder="0,00" 
                            min="0" 
                            step="0.01"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition"
                        >
                    </div>
                </div>
            </div>
            
            <button id="btn-adicionar" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-4 rounded-xl font-semibold hover:from-purple-700 hover:to-purple-800 transition shadow-lg shadow-purple-500/30">
                Adicionar Produto
            </button>
        </div>
    </div>

    <script>
      // Configuração do QuaggaJS
      const config = {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector("#interactive"),
          constraints: {
            facingMode: "environment",
            aspectRatio: { min: 1, max: 2 },
          },
        },
        decoder: {
          readers: [
            "ean_reader",
            "ean_8_reader",
            "code_128_reader",
            "code_39_reader",
          ],
          multiple: false,
        },
        locate: true,
        locator: {
          patchSize: "medium",
          halfSample: true,
        },
        frequency: 10,
      };

      // Elementos de navegação e telas
      const homeScreen = document.getElementById("home-screen");
      const scannerArea = document.getElementById("scanner-area");
      const btnLer = document.getElementById("btn-ler");
      const btnHome = document.getElementById("btn-home");
      const nomeProdutoEl = document.getElementById("nome-produto");

      // Elementos do DOM
      const interactive = document.getElementById("interactive");
      const modal = document.getElementById("product-modal");
      const closeModalBtn = document.querySelector(".close-button");
      const modalProductName = document.getElementById("modal-product-name");
      const inputQuantidade = document.getElementById("input-quantidade");
      const inputValor = document.getElementById("input-valor");
      const btnAdicionar = document.getElementById("btn-adicionar");

      let scannerEmFuncionamento = false;
      let codigoEncontrado = null;

      // --- FUNÇÕES DE NAVEGAÇÃO ---

      function mostrarTela(tela) {
        homeScreen.classList.add("hidden");
        scannerArea.classList.add("hidden");

        if (tela === "home") {
          homeScreen.classList.remove("hidden");
          pararScanner();
        } else if (tela === "scanner") {
          scannerArea.classList.remove("hidden");
        }
      }

      // --- FUNÇÕES DO SCANNER ---

      function pararScanner(callback) {
        if (!scannerEmFuncionamento) return;

        Quagga.stop(function () {
          console.log("Scanner QuaggaJS parado (callback executado).");

          const video = interactive.querySelector("video");
          if (video && video.srcObject) {
            video.srcObject.getTracks().forEach((track) => {
              track.stop();
            });
            video.srcObject = null;
          }

          const codigoDetectado = codigoEncontrado;
          codigoEncontrado = null;
          interactive.innerHTML = "";
          nomeProdutoEl.textContent = "Aguardando código...";

          btnLer.querySelector("span").textContent = "Ler";

          if (!codigoDetectado) {
            abrirModalManual();
          }

          if (callback) callback();
        });

        scannerEmFuncionamento = false;
      }

      function iniciarScanner() {
        if (scannerEmFuncionamento) return;

        mostrarTela("scanner");
        interactive.innerHTML = "";

        btnLer.querySelector("span").textContent = "Parar";

        Quagga.init(config, function (err) {
          if (err) {
            console.error("Erro ao inicializar o Quagga:", err);
            alert("Erro ao iniciar a câmera! Verifique as permissões.");
            mostrarTela("home");
            return;
          }
          Quagga.start();
          scannerEmFuncionamento = true;
          console.log("Scanner QuaggaJS iniciado.");
        });
      }

      // Quando um código é detectado
      Quagga.onDetected(function (data) {
        const codigo = data.codeResult.code;

        if (codigo && codigo.length === 13 && codigo !== codigoEncontrado) {
          codigoEncontrado = codigo;
          pararScanner();
          buscarProduto(codigo);
        }
      });

      // --- FUNÇÕES DO MODAL ---

      function abrirModal(nome, ean) {
            modalProductName.textContent = nome;
            inputQuantidade.value = "";
            inputValor.value = "";
            modal.classList.remove('hidden');
            inputQuantidade.focus();
            modal.dataset.ean = ean;
            console.log(`Modal aberto para EAN: ${ean}`);
        }

      function abrirModalManual() {
        abrirModal("Inserir Produto Manualmente", "MANUAL");
        nomeProdutoEl.textContent = "Scanner Parado. Insira o produto.";
      }

      function fecharModal() {
        modal.classList.add("hidden");
        if (
          !scannerEmFuncionamento &&
          scannerArea.classList.contains("hidden")
        ) {
          mostrarTela("home");
        }
      }

      // --- EVENT LISTENERS ---

      document.addEventListener("DOMContentLoaded", () => {
        btnLer.addEventListener("click", () => {
          if (scannerEmFuncionamento) {
            pararScanner();
          } else {
            iniciarScanner();
          }
        });

        btnHome.addEventListener("click", () => {
          mostrarTela("home");
        });

        closeModalBtn.addEventListener("click", fecharModal);

        window.addEventListener("click", (event) => {
          if (event.target == modal) {
            fecharModal();
          }
        });

        btnAdicionar.addEventListener("click", () => {
          const ean = modal.dataset.ean;
          const nome = modalProductName.textContent;
          const quantidade = inputQuantidade.value;
          const valor = inputValor.value;
          let qtd = parseFloat(quantidade);
          let preco = parseFloat(valor);
          let total = qtd * preco;
          const totalFormatado = total.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
          });

          console.log(
            `Adicionado: EAN=${ean}, Produto=${nome}, Qtd=${qtd}, Valor=${preco}`
          );
          alert(
            `Produto adicionado!\n${nome} (Qtd: ${qtd}, Total: ${totalFormatado})`
          );

          fecharModal();
        });
      });

      // --- FUNÇÃO DE BUSCA NA API DE PRODUTOS ---

      const API_KEY = "P7uKcTcma8P8GLzyw0ICeA";
      const COSMOS_API_URL = "https://api.cosmos.bluesoft.com.br/gtins/";

      async function buscarProduto(ean) {
        nomeProdutoEl.textContent = "Buscando dados do produto...";

        const url = `${COSMOS_API_URL}${ean}`;

        try {
          const response = await fetch(url, {
            method: "GET",
            headers: {
              "X-Cosmos-Token": API_KEY,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            nomeProdutoEl.textContent = `Erro: ${response.status}. Produto não encontrado (${ean}).`;
            abrirModalManual();
            return;
          }

          const data = await response.json();
          const nomeProduto =
            data.description || "Produto sem descrição (EAN: " + ean + ")";

          nomeProdutoEl.textContent = nomeProduto;
          abrirModal(nomeProduto, ean);
        } catch (error) {
          console.error("Erro na busca da API:", error);
          nomeProdutoEl.textContent =
            "Falha ao conectar com o serviço de produtos.";
          abrirModalManual();
        }
      }
    </script>
  </body>
</html>
