<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marry Market</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
      body {
        font-family: "Satoshi", sans-serif;
        background-image: url("grocery.webp");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      #interactive {
        width: 100%;
        height: 100%;
      }

      #interactive video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      /* Alterado */
      .scanner-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        /* Ajustado para coincidir aproximadamente com a 'area' configurada no JS */
        width: 70%; /* Correspondente a 100% - (left 15% + right 15%) */
        height: 50%; /* Correspondente a 100% - (top 25% + bottom 25%) */
        border: 3px solid #fcd34d;
        border-radius: 24px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        pointer-events: none;
      }

      .scanner-line {
        position: absolute;
        width: 100%;
        height: 3px;
        background: #fcd34d;
        top: 50%;
      }

      @keyframes scan {
        0%,
        100% {
          top: 10%;
        }
        50% {
          top: 90%;
        }
      }

      .corner {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 4px solid #fcd34d;
      }

      .corner-tl {
        top: -2px;
        left: -2px;
        border-right: none;
        border-bottom: none;
        border-radius: 24px 0 0 0;
      }
      .corner-tr {
        top: -2px;
        right: -2px;
        border-left: none;
        border-bottom: none;
        border-radius: 0 24px 0 0;
      }

      .corner-bl {
        bottom: -2px;
        left: -2px;
        border-right: none;
        border-top: none;
        border-radius: 0 0 0 24px;
      }

      .corner-br {
        bottom: -2px;
        right: -2px;
        border-left: none;
        border-top: none;
        border-radius: 0 0 24px 0;
      }

      .product-modal-container {
        max-height: 80vh;
        overflow-y: auto;
      }
    </style>
  </head>
  <body class="h-screen overflow-hidden">
    <header id="main-header">
      <h2 class="ms-4 mt-8 text-2xl text-white">
        Total: <span class="text-xl" id="valor-total-header">R$ 0,00</span>
      </h2>
    </header>

    <div id="home-screen" class="h-full flex flex-col items-center justify-center p-6">
      <div id="nome-produto" class="text-lg text-gray-100 font-medium mb-4"></div>
    </div>

    <div id="scanner-area" class="hidden fixed inset-0 w-full h-full">
      <div id="interactive" class="w-full h-full bg-gray-900"></div>

      <div class="scanner-overlay">
        <div class="corner corner-tl"></div>
        <div class="corner corner-tr"></div>
        <div class="corner corner-bl"></div>
        <div class="corner corner-br"></div>
        <div class="scanner-line"></div>
      </div>

      <div id="manual-input-container" class="hidden fixed bottom-40 left-0 right-0 z-50 text-center px-4">
        <button id="btn-manual" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-full shadow-xl hover:bg-green-700 transition">
          Inserir Manualmente
        </button>
      </div>
    </div>

    <div
      class="fixed bottom-0 left-0 right-0 z-30 bg-gradient-to-t from-black/80 to-transparent pb-8 pt-6"
    >
      <div class="flex justify-around items-end px-8 max-w-md mx-auto">
        <button
          id="btn-home"
          class="flex flex-col items-center gap-2 text-white/70 hover:text-white transition"
        >
          <div
            class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              />
            </svg>
          </div>
          <span class="text-xs font-medium">Lista</span>
        </button>
        <button
          id="btn-ler"
          class="flex flex-col items-center gap-2 text-white/70 hover:text-white transition"
        >
          <div
            class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
              />
            </svg>
          </div>
          <span class="text-white text-xs font-medium">Ler</span>
        </button>

        <a
          href="perfil.html"
          class="flex flex-col items-center gap-2 text-white/70 hover:text-white transition"
        >
          <div
            class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="w-6 h-6"
            >
              <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />

              <circle cx="12" cy="7" r="4" />
            </svg>
          </div>
          <span class="text-xs font-medium">Perfil</span>
        </a>
      </div>
    </div>

    <div id="product-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-40 flex p-4 items-start justify-center">
      <div class="bg-white rounded-3xl w-full max-w-md p-5 mt-4">
        <div class="flex justify-end mb-2">
          <button class="close-button text-gray-400 hover:text-gray-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="mb-4">
          <div class="bg-green-50 rounded-xl p-2 mb-4">
            <p id="modal-product-name" class="text-green-900 font-medium text-center">
              Nome do Produto
            </p>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
              <input type="number" id="input-quantidade" value="1" min="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-300 focus:outline-none transition"/>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Valor (R$)</label>
              <input type="number" id="input-valor" placeholder="0.00" min="0" step="0.01" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-300 focus:outline-none transition"/>
            </div>
          </div>
        </div>

        <button id="btn-adicionar" class="w-full bg-gradient-to-r from-green-400 to-green-500 text-white py-3 rounded-xl font-semibold hover:from-green-500 hover:to-green-600 transition shadow-lg shadow-green-500/30">
          Adicionar Produto
        </button>
      </div>
    </div>

    <div id="list-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-40 flex p-4 items-end justify-center sm:items-center">
      <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md p-5 product-modal-container">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800">Lista de Compras</h2>
          <button class="close-list-button text-gray-400 hover:text-gray-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <ul id="lista-produtos" class="space-y-3 mb-4">
          <li id="lista-vazia-mensagem" class="bg-gray-100 p-4 rounded-xl shadow-inner text-center text-gray-500">
            A lista est치 vazia.
          </li>
        </ul>

        <div class="flex justify-between items-center pt-3 border-t border-gray-200">
          <span class="text-lg font-bold text-gray-800">Total:</span>
          <span id="valor-total-modal" class="text-xl font-extrabold text-green-500">R$ 0,00</span
          >
        </div>

        <button id="btn-limpar-lista" class="mt-4 w-full bg-red-500 text-white py-3 rounded-xl font-semibold hover:bg-red-600 transition disabled:opacity-50" disabled>
          Limpar Lista
        </button>
      </div>
    </div>

    <script>
      // Configura칞칚o do QuaggaJS (alterada)
      const config = {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector("#interactive"),
          constraints: {
            width: 640,
            height: 480,
            facingMode: "environment",
          },
          // 츼REA DE LEITURA: Define onde o scanner deve focar
          // top/right/left/bottom variam de 0% a 100%
          area: {
            top: "25%", // Ignora os 25% superiores
            right: "15%", // Ignora os 15% da direita
            left: "15%", // Ignora os 15% da esquerda
            bottom: "25%", // Ignora os 25% inferiores
          },
        },
        // FREQU칅NCIA: Quantas vezes ele tenta ler por segundo.
        // Diminuir para 3 ou 5 torna a leitura menos "desesperada".
        frequency: 5,
        decoder: {
          readers: ["ean_reader", "ean_8_reader"],
          multiple: false,
        },
        locate: true,
        locator: {
          patchSize: "medium",
          halfSample: true,
        },
      };

      // Elementos de navega칞칚o e telas (mantidos)
      const homeScreen = document.getElementById("home-screen");
      const scannerArea = document.getElementById("scanner-area");
      const btnLer = document.getElementById("btn-ler");
      const btnHome = document.getElementById("btn-home");
      const nomeProdutoEl = document.getElementById("nome-produto");
      const manualInputContainer = document.getElementById("manual-input-container");
      const btnManual = document.getElementById("btn-manual");

      // Elementos do DOM do Modal de Inser칞칚o (mantidos)
      const interactive = document.getElementById("interactive");
      const productModal = document.getElementById("product-modal");
      const closeModalBtn = productModal.querySelector(".close-button");
      const modalProductName = document.getElementById("modal-product-name");
      const inputQuantidade = document.getElementById("input-quantidade");
      const inputValor = document.getElementById("input-valor");
      const btnAdicionar = document.getElementById("btn-adicionar");

      // Elementos do DOM do Modal da Lista (mantidos)
      const listModal = document.getElementById("list-modal");
      const closeListModalBtn = listModal.querySelector(".close-list-button");
      const listaProdutosEl = document.getElementById("lista-produtos");
      const valorTotalHeaderEl = document.getElementById("valor-total-header");
      const valorTotalModalEl = document.getElementById("valor-total-modal");
      const listaVaziaMsg = document.getElementById("lista-vazia-mensagem");
      const btnLimparLista = document.getElementById("btn-limpar-lista");

      let scannerEmFuncionamento = false;
      let codigoEncontrado = null;
      let timerEsperaLeitura;

      // Chave do localStorage para a lista de compras (mantida)
      const STORAGE_KEY = "listaDeProdutos";
      // CHAVE NOVA: Hist칩rico do 칰ltimo pre칞o visto (Chave para o mapeamento EAN -> Pre칞o)
      const STORAGE_HISTORY_KEY = "historicoPrecos";

      // --- FUN칂칏ES DE ARMAZENAMENTO E C츼LCULO ---

      /** Carrega a lista de produtos do localStorage. */
      function carregarLista() {
        const listaJSON = localStorage.getItem(STORAGE_KEY);
        return listaJSON ? JSON.parse(listaJSON) : [];
      }

      /** Salva a lista de produtos no localStorage. */
      function salvarLista(lista) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
        atualizarTotalELista();
      }

      /** NOVO: Carrega o mapa de hist칩rico de pre칞os do localStorage. */
      function carregarHistorico() {
        const historicoJSON = localStorage.getItem(STORAGE_HISTORY_KEY);
        return historicoJSON ? JSON.parse(historicoJSON) : {};
      }

      /** NOVO: Salva o 칰ltimo pre칞o unit치rio de um produto no hist칩rico. */
      function salvarHistoricoProduto(ean, valorUnitario) {
        if (ean === "MANUAL") return; // N칚o salva c칩digos manuais
        const historico = carregarHistorico();
        historico[ean] = valorUnitario;
        localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(historico));
      }

      /** Calcula o total de todos os produtos na lista. (mantida)*/
      function calcularTotal(lista) {
        return lista.reduce((soma, produto) => soma + produto.subtotal, 0);
      }

      /** Formata um valor num칠rico para o padr칚o de moeda BRL (R$). (mantida)*/
      function formatarMoeda(valor) {
        // Garante que o valor seja um n칰mero antes de formatar
        if (typeof valor !== "number" || isNaN(valor)) {
          return "R$ 0,00";
        }
        return valor.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      // --- FUN칂칏ES DE RENDERIZA칂츾O E ATUALIZA칂츾O (alteradas para incluir o total) ---

      /** Renderiza a lista de produtos no modal e atualiza o total no header e no modal. (mantida)*/
      function renderizarLista() {
        const lista = carregarLista();
        listaProdutosEl.innerHTML = "";

        if (lista.length === 0) {
          listaProdutosEl.appendChild(listaVaziaMsg);
          btnLimparLista.disabled = true;
        } else {
          btnLimparLista.disabled = false;
          lista.forEach((produto, index) => {
            const listItem = document.createElement("li");
            listItem.className =
              "bg-gray-50 p-3 rounded-xl shadow-sm flex justify-between items-center border border-gray-200";
            listItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-900">${
                          produto.nome
                        }</p>
                        <p class="text-xs text-gray-500">Qtd: ${
                          produto.quantidade
                        } x ${formatarMoeda(produto.valorUnitario)}</p>
                    </div>
                    <div class="text-right flex items-center gap-3">
                        <p class="font-bold text-base text-green-500">${formatarMoeda(
                          produto.subtotal
                        )}</p>
                        <button data-index="${index}" class="btn-remover text-red-500 hover:text-red-700 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
            listaProdutosEl.appendChild(listItem);
          });

          // Adiciona listeners aos bot칫es de remo칞칚o
          document.querySelectorAll(".btn-remover").forEach((button) => {
            button.addEventListener("click", removerProduto);
          });
        }

        const total = calcularTotal(lista);
        valorTotalHeaderEl.textContent = formatarMoeda(total);
        valorTotalModalEl.textContent = formatarMoeda(total);
      }

      /** Atualiza os totais nas telas (Header e Modal). (mantida)*/
      function atualizarTotalELista() {
        renderizarLista();
      }

      /** Remove um produto da lista pelo seu 칤ndice. (mantida)*/
      function removerProduto(event) {
        const index = parseInt(event.currentTarget.dataset.index);
        let lista = carregarLista();

        if (index > -1 && index < lista.length) {
          lista.splice(index, 1);
          salvarLista(lista);
        }
      }

      /** Limpa toda a lista de produtos. (mantida)*/
      function limparLista() {
        if (confirm("Tem certeza que deseja limpar toda a lista de compras?")) {
          salvarLista([]);
          alert("Lista limpa!");
        }
      }

      // --- FUN칂칏ES DE NAVEGA칂츾O E MODAIS (A fun칞칚o abrirProductModal foi modificada) ---

      function mostrarTela(tela) {
        homeScreen.classList.add("hidden");
        scannerArea.classList.add("hidden");

        if (tela === "home") {
          homeScreen.classList.remove("hidden");
          pararScanner();
        } else if (tela === "scanner") {
          scannerArea.classList.remove("hidden");
        }
      }

      /** * Fun칞칚o MODIFICADA:
       * 1. Verifica hist칩rico.
       * 2. Aplica cor roxa e mensagem se o EAN estiver no hist칩rico.
       */
      function abrirProductModal(nome, ean) {
        // Limpa classes e conte칰do anterior
        modalProductName.textContent = nome;
        // modalProductName.className = "text-green-900 font-medium text-center";

        // Remove qualquer span de compara칞칚o que possa ter sobrado
        const oldComparison = document.getElementById("price-comparison-span");
        if (oldComparison) oldComparison.remove();

        // ------------------ L칩gica de Hist칩rico ------------------
        const historico = carregarHistorico();
        const precoAnterior = historico[ean];

        if (precoAnterior !== undefined) {
          // MODO: Produto Conhecido (Hist칩rico Encontrado)
          modalProductName.textContent = nome;
          modalProductName.className = "text-black font-medium text-center bg-green-500 rounded-lg p-2";

          // Cria o span de compara칞칚o de pre칞o
          const comparisonSpan = document.createElement("span");
          comparisonSpan.id = "price-comparison-span";
          comparisonSpan.className = "block text-xs font-semibold mt-1 text-green-500";
          comparisonSpan.textContent = `Pre칞o da 칰ltima compra: ${formatarMoeda(precoAnterior)}`;

          // Insere o span abaixo do input de valor
          const valorDiv = document.getElementById("input-valor").parentNode;
          valorDiv.appendChild(comparisonSpan);

          // Sugere o pre칞o anterior no input para facilitar a inser칞칚o
          inputValor.value = "";
        } else {
          // MODO: Produto Novo
          // Limpa o campo de valor
          inputValor.value = "";
        }
        // ---------------------------------------------------------

        inputQuantidade.value = ""; // Volta ao padr칚o

        productModal.classList.remove("hidden");
        inputQuantidade.focus();
        productModal.dataset.ean = ean;
      }

      function fecharProductModal() {
        productModal.classList.add("hidden");
        if (scannerArea.classList.contains("hidden")) {
          pararScanner();
          mostrarTela("home");
        }
      }

      function abrirListModal() {
        renderizarLista();
        listModal.classList.remove("hidden");
      }

      function fecharListModal() {
        listModal.classList.add("hidden");
      }

      // --- FUN칂칏ES DO SCANNER (mantidas) ---

      function pararScanner(callback) {
        if (!scannerEmFuncionamento) return;
        clearTimeout(timerEsperaLeitura);
        manualInputContainer.classList.add("hidden");

        // ... (l칩gica de Quagga.stop e tracks.stop)
        Quagga.stop(function () {
          const video = interactive.querySelector("video");
          if (video && video.srcObject) {
            video.srcObject.getTracks().forEach((track) => {
              track.stop();
            });
            video.srcObject = null;
          }

          codigoEncontrado = null;
          interactive.innerHTML = "";

          if (callback) callback();
        });

        scannerEmFuncionamento = false;
      }

      function iniciarScanner() {
        if (scannerEmFuncionamento) return;

        mostrarTela("scanner");
        interactive.innerHTML = "";

        Quagga.init(config, function (err) {
          if (err) {
            console.error("Erro ao inicializar o Quagga:", err);
            alert("Erro ao iniciar a c칙mera! Verifique as permiss칫es.");
            mostrarTela("home");
            return;
          }
          Quagga.start();
          scannerEmFuncionamento = true;
          iniciarTimerManual();
        });
      }

      function iniciarTimerManual() {
        // Define o tempo de espera em milissegundos (5 segundos)
        const TEMPO_ESPERA_MS = 5000;

        // Limpa qualquer timer anterior para garantir que s칩 haja um ativo
        clearTimeout(timerEsperaLeitura);

        timerEsperaLeitura = setTimeout(() => {
          // Se o scanner ainda estiver funcionando ap칩s 5 segundos, mostra o bot칚o
          if (scannerEmFuncionamento) {
            manualInputContainer.classList.remove("hidden");
          }
        }, TEMPO_ESPERA_MS);
      }

      // Quando um c칩digo 칠 detectado (mantida)
      Quagga.onDetected(function (data) {
        const codigo = data.codeResult.code;

        if (codigo && codigo.length === 13 && codigo !== codigoEncontrado) {
          codigoEncontrado = codigo;
          clearTimeout(timerEsperaLeitura);
          manualInputContainer.classList.add("hidden");
          pararScanner();
          mostrarTela("home");
          buscarProduto(codigo);
        }
      });

      function abrirModalManual() {
        abrirProductModal("Novo Produto", "MANUAL");
        // nomeProdutoEl.textContent = "Scanner Parado. Insira o produto.";
      }

      // --- FUN칂츾O DE BUSCA NA API DE PRODUTOS (mantida) ---

      const API_KEY = "P7uKcTcma8P8GLzyw0ICeA"; // (Sua chave)
      const COSMOS_API_URL = "https://api.cosmos.bluesoft.com.br/gtins/";

      async function buscarProduto(ean) {
        nomeProdutoEl.textContent = "Buscando dados do produto...";

        const url = `${COSMOS_API_URL}${ean}`;

        try {
          // ... (l칩gica de fetch)
          const response = await fetch(url, {
            method: "GET",
            headers: {
              "X-Cosmos-Token": API_KEY,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            nomeProdutoEl.textContent = `Erro: ${response.status}. Produto n칚o encontrado (${ean}).`;
            abrirModalManual();
            return;
          }

          const data = await response.json();
          const nomeProduto =
            data.description || "Produto sem descri칞칚o (EAN: " + ean + ")";

          nomeProdutoEl.textContent = nomeProduto;
          abrirProductModal(nomeProduto, ean); // Chama a fun칞칚o modificada
        } catch (error) {
          console.error("Erro na busca da API:", error);
          nomeProdutoEl.textContent =
            "Falha ao conectar com o servi칞o de produtos.";
          abrirModalManual();
        }
      }

      // --- EVENT LISTENERS (Modificado para SALVAR O HIST칍RICO) ---

      document.addEventListener("DOMContentLoaded", () => {
        atualizarTotalELista();

        // ... (Listeners btnLer, btnHome, closeModalBtn, closeListModalBtn, btnLimparLista)
        btnLer.addEventListener("click", () => {
          if (scannerEmFuncionamento) {
            pararScanner();
            mostrarTela("home");
          } else {
            iniciarScanner();
          }
        });

        btnHome.addEventListener("click", abrirListModal);
        closeModalBtn.addEventListener("click", fecharProductModal);
        productModal.addEventListener("click", (event) => {
          if (event.target === productModal) {
            fecharProductModal();
          }
        });

        closeListModalBtn.addEventListener("click", fecharListModal);
        listModal.addEventListener("click", (event) => {
          if (event.target === listModal) {
            fecharListModal();
          }
        });

        btnLimparLista.addEventListener("click", limparLista);

        // Adicionar Produto (L칩gica modificada para salvar no hist칩rico)
        btnAdicionar.addEventListener("click", () => {
          const ean = productModal.dataset.ean;
          const nome = modalProductName.textContent;
          const quantidade = inputQuantidade.value;
          const valor = inputValor.value;

          let qtd = parseFloat(quantidade);
          let preco = parseFloat(valor.replace(",", "."));

          if (isNaN(qtd) || qtd <= 0) {
            alert("Por favor, insira uma quantidade v치lida.");
            return;
          }
          if (isNaN(preco) || preco < 0) {
            alert("Por favor, insira um valor v치lido.");
            return;
          }

          let subtotal = qtd * preco;

          const novoProduto = {
            nome: nome,
            quantidade: qtd,
            valorUnitario: preco,
            subtotal: subtotal,
            ean: ean,
          };

          // 1. Salva na lista de compras
          const listaAtual = carregarLista();
          listaAtual.push(novoProduto);
          salvarLista(listaAtual);

          // 2. NOVO: Salva o valor unit치rio no hist칩rico para compara칞칚o futura
          salvarHistoricoProduto(ean, preco);

          Swal.fire({
            title: "Produto Adicionado! 游눞",
            showConfirmButton: false,
            timer: 2000,
            toast: true,
            position: "top-end",
          });

          fecharProductModal();
          mostrarTela("home");
        });

        btnManual.addEventListener("click", () => {
          pararScanner();
          abrirModalManual();
        });

        mostrarTela("home");
      });
    </script>
  </body>
</html>
